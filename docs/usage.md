# Usage Guide

> Detailed guide for every devflow command with examples, expected output, and practical tips.

---

## Table of Contents

- [`devflow up`](#devflow-up)
- [`devflow init`](#devflow-init)
- [`devflow env`](#devflow-env)
- [`devflow port`](#devflow-port)
- [`devflow watch`](#devflow-watch)
- [`devflow logs`](#devflow-logs)
- [`devflow deps`](#devflow-deps)
- [`devflow snap`](#devflow-snap)
- [`devflow dash`](#devflow-dash)
- [`devflow plugin`](#devflow-plugin)
- [Typical Workflows](#typical-workflows)

---

## `devflow up`

Detects project language, checks local toolchain presence, validates `.env` against `.devflow.yaml`, and reports recommendations.

### What It Checks

1. **Project language**: Scans for marker files (`Cargo.toml`, `package.json`, `pyproject.toml`, `go.mod`) and reports the detected language.
2. **Toolchain**: Verifies the language-specific binary (`rustc`, `node`, `python`, `go`) is available in `PATH`.
3. **Version hint**: Reads version hint files (`.nvmrc`, `rust-toolchain`, `go.mod`, `pyproject.toml`) to show expected versions.
4. **Docker Compose**: Reports whether `docker-compose.yml` or `compose.yaml` exists.
5. **Env schema**: If `.devflow.yaml` exists, validates `.env` variables against the declared schema.

### Example Output

```
devflow up status
-----------------
language: Rust
toolchain: ok (C:\Users\dev\.cargo\bin\rustc.exe)
expected version hint: 1.75.0
services: docker-compose file detected
env: schema matches .env
```

### When Schema Issues Exist

```
env: 2 issues
 - PORT: missing
 - DEBUG: expected bool
recommendation: run `devflow env doctor` and `devflow env fix`
```

### When No Config Exists

```
recommendation: run `devflow init` to create .devflow.yaml
```

---

## `devflow init`

Creates a `.devflow.yaml` template in the current directory with reasonable defaults.

### Behavior

- **First run**: Creates the file with sample env schema, services, start commands, test command, ignore globs, and desired ports.
- **Subsequent runs**: Prints `.devflow.yaml already exists` and exits without modification.

### Generated File

```yaml
env:
  DATABASE_URL: string
  PORT: int
services:
- name: app
  command: cargo run
start_commands:
- docker compose up -d
test_command: cargo test
ignore_globs:
- target/**
- node_modules/**
desired_ports:
- 3000
- 5432
```

### Next Steps After Init

1. Edit `.devflow.yaml` to match your project's actual env vars, services, and ports.
2. Create or update your `.env` file with the required variables.
3. Run `devflow up` to verify everything is configured correctly.
4. See the [Init Walkthrough](init-walkthrough.md) for a step-by-step guide.

---

## `devflow env`

Three subcommands for environment management.

### `devflow env doctor`

Comprehensive environment health check.

**What it checks**:
1. Is `PATH` set in the environment?
2. Is `python` or `python3` available in `PATH`?
3. Is `node` available in `PATH`?
4. If `.devflow.yaml` exists: does each declared env var exist in `.env` with the correct type?

**Example output** (healthy):
```
env doctor: healthy
```

**Example output** (issues found):
```
env doctor: 3 issue(s)
 - Node not found in PATH
 - env PORT: missing
 - env DEBUG: expected bool
```

### `devflow env fix`

Creates a minimal `.env` file if one doesn't exist.

**Example**:
```
# If no .env exists:
created .env

# If .env exists:
.env already exists; no changes
```

The generated `.env` contains only a comment header: `# generated by devflow env fix`

### `devflow env diff`

Tracks changes to your `.env` file over time.

**First run**:
```
saved first env snapshot
```
Saves the current `.env` to `.devflow/env_snapshot.json` as a baseline.

**Subsequent runs** (after modifying `.env`):
```
added: NEW_VAR
changed: DATABASE_URL
removed: OLD_VAR
```

---

## `devflow port`

Port diagnostics: discover free ports, inspect port owners, and live-monitor.

### `devflow port` (default: inspect port 3000)

```bash
devflow port
# or explicitly:
devflow port --port 3000
```

**Output when a process is found**:
```
Port 3000 is owned by pid 12345
parent pid: 12340
cmd: node server.js --port 3000
mem: 45678 KB
uptime: 120 sec
tip: Try graceful stop first: kill 12345
tip: If needed force stop: kill -9 12345
tip: Windows graceful: taskkill /PID 12345
tip: Windows force: taskkill /F /PID 12345
```

**Output when no process is found**:
```
No process found for port 3000
```

### `devflow port --free`

Lists common development ports that are currently available.

```json
[3000, 3001, 5173, 8000, 8080, 5432, 6379]
```

(Only ports that are actually free will appear in the list.)

### `devflow port --watch`

Live-monitors common development ports every 2 seconds.

```
Watching common dev ports every 2s (ctrl+c to stop)
port 3000 pid=12345 parent=Some(12340) mem=45678KB uptime=120s cmd=node server.js
port 5432 pid=67890 parent=Some(1) mem=12345KB uptime=3600s cmd=postgres
```

Press `Ctrl+C` to stop.

---

## `devflow watch`

Watches the filesystem for changes and automatically runs tests.

### How It Works

1. Loads ignore patterns from `ignore_globs` in `.devflow.yaml`.
2. Sets up a recursive file watcher on the project root.
3. When files change (and aren't ignored), detects the project language and runs the appropriate test command.
4. Reports the number of changed files and the test result.

### Example Session

```
watching for changes...
changed files: 2
test run status: exit status: 0
changed files: 1
test run status: exit status: 1
```

### Configuring Ignore Patterns

Edit `.devflow.yaml`:

```yaml
ignore_globs:
  - target/**
  - node_modules/**
  - .git/**
  - "*.log"
```

---

## `devflow logs`

Groups repeated error lines in `devflow.log` and tracks newly seen errors.

### How It Works

1. Reads `devflow.log` from the current directory.
2. Filters for lines containing `ERROR` or `panic`.
3. Normalizes numeric tokens (PIDs, timestamps, line numbers) to `<n>` for better grouping.
4. Counts the frequency of each unique error pattern.
5. Compares with the previous run to highlight new errors.

### Example Output

```
Grouped errors:
freq=5 trace=ERROR connection refused at port <n>
freq=2 trace=ERROR panic at 'index out of bounds'
new_error_since_last_run: ERROR disk quota exceeded
first_seen_reference: 2026-02-24T10:30:00Z
```

---

## `devflow deps`

Prints dependency metadata and offline risk hints for Python/Node/Rust projects.

### Python

```
python deps
requirements: true
poetry.lock: false
license_risk_summary: unknown (offline mode)
```

### Node

```
node deps
package.json: true
lock file: true
declared packages: 15
outdated packages: run npm outdated for full list
```

### Rust

```
rust deps
cargo.lock: true
top transitive bloat: run cargo tree -e features -i <crate>
license_risk_summary: run cargo deny when available
```

---

## `devflow snap`

Save and inspect process/environment snapshots.

### `devflow snap save`

Captures:
- Running processes related to the project directory
- Non-secret environment variables
- Timestamp

```
snapshot saved to .devflow/snapshot.json
```

### `devflow snap restore`

Displays the saved snapshot (does not restart processes):

```
snapshot from 2026-02-24T10:30:00Z
repo: /home/user/my-project
would restore: node server.js --port 3000
would restore: postgres /usr/lib/postgresql/15/bin/postgres
```

---

## `devflow dash`

Opens an interactive terminal dashboard with real-time system metrics.

### Layout

```
┌─Status──────────────────────────────┐
│ devflow dash (press q to quit)      │
├─System──────────────────────────────┤
│ CPU: 12.5% | MEM: 8388608 KB | PROCS: 256 │
├─Workspace───────────────────────────┤
│ services: local                     │
│ ports: use devflow port --watch     │
│ tests: use devflow watch            │
└─────────────────────────────────────┘
```

Press `q` to exit.

---

## `devflow plugin`

Runs an external executable plugin.

### Basic Usage

```bash
# Run a plugin by name
devflow plugin infra-check

# Pass a JSON payload
devflow plugin infra-check --payload '{"region": "us-east-1"}'
```

### Example Output

```json
{
  "ok": true,
  "message": "infra credentials healthy",
  "data": {
    "command": "infra-check",
    "missing": []
  }
}
```

### See Also

- [Plugin Development Guide](plugin.md) for writing your own plugins.

---

## Typical Workflows

### New Project Setup

```bash
cd my-project
devflow init          # Create .devflow.yaml
# Edit .devflow.yaml to match your project
devflow up            # Verify environment
devflow env doctor    # Check for issues
devflow env fix       # Create .env if needed
```

### Daily Development

```bash
devflow up            # Morning health check
devflow watch         # Start file watcher (keep running)
# In another terminal:
devflow port --watch  # Monitor ports
```

### Debugging Environment Issues

```bash
devflow env doctor    # See all issues
devflow env diff      # Check what changed in .env
devflow port --port 3000  # Who's using my port?
devflow logs          # Any new errors?
```

### Before Going on Vacation

```bash
devflow snap save     # Save current workspace state
# When you're back:
devflow snap restore  # See what was running
devflow up            # Verify everything still works
```
